#!/bin/bash
set -e

# Pre-commit hook: PHP-CS-Fixer + PHPStan

echo "üîç Pre-commit checks..."

# Verificar si vendor existe
if [ ! -d "vendor" ]; then
    echo "‚ö†Ô∏è  vendor/ no existe. Ejecuta 'composer install' primero."
    exit 1
fi

# Obtener archivos PHP staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.php$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No hay archivos PHP staged, saltando validaciones."
    exit 0
fi

# 1. PHP-CS-Fixer (auto-fix)
echo "üîß Ejecutando PHP-CS-Fixer..."
echo "$STAGED_FILES" | xargs vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.dist.php --quiet
echo "$STAGED_FILES" | xargs git add

# 2. PHPStan (solo archivos en src/ o tests/)
echo "üîç Ejecutando PHPStan en archivos modificados..."
ANALYZED_FILES=$(echo "$STAGED_FILES" | grep -E '^(src|tests)/' || true)

if [ -n "$ANALYZED_FILES" ]; then
    if ! echo "$ANALYZED_FILES" | xargs vendor/bin/phpstan analyse --no-progress --error-format=table; then
        echo ""
        echo "‚ùå PHPStan encontr√≥ errores."
        echo ""
        echo "Opciones:"
        echo "  1. Corrige los errores y vuelve a intentar el commit"
        echo "  2. Usa 'git commit --no-verify' para saltar esta validaci√≥n (NO RECOMENDADO)"
        echo ""
        exit 1
    fi
fi

echo "‚úÖ Pre-commit checks completados."
exit 0
