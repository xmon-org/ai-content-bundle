services:
    _defaults:
        autowire: true
        autoconfigure: true

    # Form Types
    Xmon\AiContentBundle\Form\AiStyleConfigType:
        arguments:
            $imageOptionsService: '@Xmon\AiContentBundle\Service\ImageOptionsService'
        tags: ['form.type']

    # Image Provider (Pollinations)
    Xmon\AiContentBundle\Provider\Image\PollinationsImageProvider:
        arguments:
            $apiKey: null
            $model: 'flux'
            $fallbackModels: []
            $retriesPerModel: 2
            $retryDelay: 3
            $timeout: 120
            $defaultWidth: 1280
            $defaultHeight: 720
            $quality: 'high'
            $negativePrompt: 'worst quality, blurry, text, letters, watermark, human faces, detailed faces'
            $private: true
            $nofeed: true
        tags:
            - { name: 'monolog.logger', channel: 'ai' }

    # Main Image Service
    Xmon\AiContentBundle\Service\AiImageService:
        arguments:
            $provider: '@Xmon\AiContentBundle\Provider\Image\PollinationsImageProvider'
            $taskConfigService: '@Xmon\AiContentBundle\Service\TaskConfigService'
        tags:
            - { name: 'monolog.logger', channel: 'ai' }

    # Image Options Service (styles, compositions, palettes, extras, presets, styleSuffix)
    Xmon\AiContentBundle\Service\ImageOptionsService:
        arguments:
            $styles: []
            $compositions: []
            $palettes: []
            $extras: []
            $presets: []
            $styleSuffix: ''

    # Variant Selector (selects variants based on content)
    Xmon\AiContentBundle\Service\VariantSelector:
        tags:
            - { name: 'monolog.logger', channel: 'ai' }

    # Prompt Template Service (configurable system/user prompts)
    Xmon\AiContentBundle\Service\PromptTemplateService:
        arguments:
            $templates: []
            $variantSelector: '@Xmon\AiContentBundle\Service\VariantSelector'
        tags:
            - { name: 'monolog.logger', channel: 'ai' }

    # Prompt Builder (combines subject with style options)
    Xmon\AiContentBundle\Service\PromptBuilder: ~

    # Image Subject Generator (two-step anchor extraction for unique subjects)
    Xmon\AiContentBundle\Service\ImageSubjectGenerator:
        arguments:
            $anchorGuidelines: []
        tags:
            - { name: 'monolog.logger', channel: 'ai' }

    # Model Registry (catalog of available models with costs)
    # Contains immutable provider data - model names, costs per response, descriptions.
    # This is the "source of truth" for what models exist and their pricing.
    Xmon\AiContentBundle\Service\ModelRegistryService: ~

    # Task Config Service (per-task model configuration)
    # Bridges ModelRegistryService with user configuration.
    # Determines which models are allowed/default for each TaskType.
    # For IMAGE_GENERATION, checks AiStyleService first (DB override via style providers).
    Xmon\AiContentBundle\Service\TaskConfigService:
        arguments:
            $modelRegistry: '@Xmon\AiContentBundle\Service\ModelRegistryService'
            $tasksConfig: []
            $styleService: '@Xmon\AiContentBundle\Service\AiStyleService'

    # Style Providers
    Xmon\AiContentBundle\Provider\Style\YamlStyleProvider:
        tags:
            - { name: 'xmon_ai_content.style_provider', priority: 0 }

    # Style Service (aggregates style providers)
    Xmon\AiContentBundle\Service\AiStyleService:
        arguments:
            $providers: !tagged_iterator { tag: 'xmon_ai_content.style_provider', default_priority_method: 'getPriority' }

    # Console Commands
    Xmon\AiContentBundle\Command\DebugConfigCommand:
        tags: ['console.command']
